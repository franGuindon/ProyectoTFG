\chapter{The Rangerx Artifact Detection System}
\label{ch:solucion}

\section{Artifact Detection System Structure}
\label{sec:sol_struct}

The Artifact Detection System generates detection masks from frames with artifacts. These masks are white on macroblocks which contain artifacts and black on the remaining artifacts. Figure \ref{fig:detector_overview} illustrates the input frame with artifacts, which is processed by the system, and finally produces the detection masks.

\begin{figure} [!h]
  \centering
  
  \includegraphics{detector_general}
  
  \caption{General Artifact Detection System Overview. }
  \label{fig:detector_overview}

\end{figure}

In order to achieve this, the Artifact Detection System must first extract features from the input frame. These features, along with a pretrained Forest Model, become the inputs to the RDF Classifier. The RDF Classifier outputs a prediction vector. The prediction vector is then mapped to the binary mask output. Figure \ref{fig:detector_steps} illustrates these steps.

\begin{figure} [!h]
  \centering
  
  \includegraphics{detector_steps}
  
  \caption{Artifact Detection process. }
  \label{fig:detector_steps}

\end{figure}

This structure was used in the dispTEC2-2022 RDF system. The Rangerx system maintains this structure and improves over the previous system by increasing the training dataset size, by redesigning the Feature Extractor and by replacing the previous RDF library with the Ranger C++ Core Library.

Section \ref{sec:sol_dataset} details the dataset construction and expansion procedure. Section \ref{sec:sol_metrics} explains the main strategies Rangerx uses to improve performance on the detection task, as measured by the Precision and Recall Metrics. This section details out the Rangerx Feature Extractor design. Section \ref{sec:sol_speed} discusses the optimizations used in Rangerx to improve on the previous system's speed. This section justifies the use of Ranger as the new RDF backend. Section \ref{sec:sol_maskgen} is a brief explanation of the Rangerx Mask Generator (This Generator is identical to the one used in dispTEC2-2022). Finally, Section \ref{sec:sol_traintest} elaborates on the training and testing procedures.

\section{Building and Expanding the Dataset}
\label{sec:sol_dataset}

The first step in expanding the training dataset is to obtain more base videos. These base videos are then processed by the Dataset Generator to produce the training feature and label dataset. Figure \ref{fig:datasetgen} enumerates the general steps in dataset generation. The video file is first processed by a Packet Loss Simulator, which produces a corresponding video with artifacts. 

\begin{figure} [!h]
  \centering
  
  \includegraphics{datasetgen}
  
  \caption{Dataset Generation procedure}
  \label{fig:datasetgen}

\end{figure}

\subsection{The Packet Loss Simulator}
\label{sec:sol_simulation}

The base videos are processed by a Packet Loss Simulator to produce corresponding videos with artefacts. Figure \ref{fig:simulator} illustrates the simulator procedure. Base video frames are encoded into H264 packets, then they are processed by a Random H264 Packet Drop system, which uses a constant drop probability. Finally, the H264 Bitstream with losses is decoded into frames with artifacts.

\begin{figure} [!h]
  \centering
  
  \includegraphics{simulator}
  
  \caption{H264 Packet Loss Simulation procedure}
  \label{fig:simulator}

\end{figure}

\subsection{The Frame Set Generator}
\label{sec:sol_framesetgen}

In order to ensure that the new dataset reduces the risk of overfitting, each new video is inspected manually and several locations of interest within the video are then described in a Video Snipping Specification File. This file is used by a Video Snipper system to then snip sets of 200 frames from each specified video location. Figure \ref{fig:framesetgen} describes the creation of the frame sets.

\begin{figure} [!h]
  \centering
  
  \includegraphics{framesetgen}
  
  \caption{Frame Set Generation procedure.}
  \label{fig:framesetgen}

\end{figure}

The locations of interest are chosen according to a subjective assessment of video content type. The project's dataset expansion goal is to have at least 18 different frame sets, each with their unique video content type, and the dataset must at least include video in 3 different lighting scenarios.

\subsection{The Video Synchronizer}
\label{sec:sol_synch}

The next step in dataset generation is to synchronize the base video with the video with artifacts. Some H264 packets encode vital metadata for the decoding of frames. When these packets are dropped, a complete frame is lost and the distorted video becomes unsynchronized with the base video. By reading the base and distorted frame timestamps in pairs, the Video Synchronizer detects when the distorted frame timestamp jumps forward, it then dumps the unmatched base frames. The next base frame timestamp should match the distorted frame. The Synchronizer outputs base frame and distorted frame pairs with matching timestamps. \ref{fig:synch} illustrates the Video Synchronization procedure.

\begin{figure} [!h]
  \centering
  
  \includegraphics{synch}
  
  \caption{Video Synchronization procedure.}
  \label{fig:synch}

\end{figure}

\subsection{The Label Generator}
\label{sec:sol_labeler}

\begin{figure} [!h]
  \centering
  
  \includegraphics{labeler}
  
  \caption{Video Labeling procedure.}
  \label{fig:labeler}

\end{figure}

\section{Improving the Detection Metrics}
\label{sec:sol_metrics}

\subsection{The Feature Extractor}
\label{sec:sol_features}

Input frames follow the I420 format. Rangerx only considers the luma component of the frame, since luma statistics correlate with artifacts much better than chroma statistics.

Figure \ref{fig:extractor_steps} describes the feature extraction strategy used in Rangerx. The new feature extractor applies a 2D High Pass Filter on the input image, which outputs a horizontally filtered frame and a vertically filtered frame.

\begin{figure} [!h]
  \centering
  
  \includegraphics{extractor_steps}
  
  \caption{Feature extraction process. }
  \label{fig:extractor_steps}

\end{figure}

\section{Improving the Detection Speed}
\label{sec:sol_speed}

\subsection{The Ranger C++ Core Library}
\label{sec:sol_rdf}

\section{The Mask Generator}
\label{sec:sol_maskgen}

\section{Training and Testing}
\label{sec:sol_traintest}


